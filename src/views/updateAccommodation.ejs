<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Editar Alojamiento</title>
  <link rel="stylesheet" href="https://unpkg.com/@picocss/pico@2.0.6/css/pico.min.css">
</head>
<body>
  <main class="container">
    <h1>Editar Alojamiento</h1>
    <div id="formErrorBox" style="color:#c00; margin-bottom:1em;"></div>
    <form action="/api/accommodations/<%= accommodation.id %>?_method=PUT" method="POST" enctype="multipart/form-data">
      <label for="title">Título</label>
      <input type="text" id="title" name="title" value="<%= accommodation.title %>" required minlength="5" maxlength="100">
      <span class="field-error" id="titleError"></span>
      <label for="description">Descripción</label>
      <textarea id="description" name="description" required minlength="30" maxlength="2000"><%= accommodation.description %></textarea>
      <span class="field-error" id="descriptionError"></span>
      <label for="pricePerNight">Precio por noche</label>
      <input type="number" id="pricePerNight" name="pricePerNight" value="<%= accommodation.pricePerNight %>" required min="10" max="100000">
      <span class="field-error" id="priceError"></span>
      <label for="squareMeters">Metros cuadrados</label>
      <input type="number" id="squareMeters" name="squareMeters" value="<%= accommodation.squareMeters %>" required min="10" max="1000">
      <span class="field-error" id="squareMetersError"></span>
      <label for="mainPhoto">Foto principal actual</label><br>
      <% if (accommodation.mainPhoto) { %>
        <img src="<%= accommodation.mainPhoto %>" alt="Foto principal" style="max-width:150px;">
      <% } %>
      <br>
      <label for="mainPhoto">Nueva foto principal (opcional)</label>
      <input type="file" id="mainPhoto" name="mainPhoto" accept="image/*">
      <span class="field-error" id="mainPhotoError"></span>
      <label for="rooms">Habitaciones</label>
      <input type="number" id="rooms" name="rooms" value="<%= accommodation.rooms %>" required min="1" max="20">
      <span class="field-error" id="roomsError"></span>
      <label for="beds">Camas</label>
      <input type="number" id="beds" name="beds" value="<%= accommodation.beds %>" required min="1" max="40">
      <span class="field-error" id="bedsError"></span>
      <label for="bathrooms">Baños</label>
      <input type="number" id="bathrooms" name="bathrooms" value="<%= accommodation.bathrooms %>" required min="1" max="20">
      <span class="field-error" id="bathroomsError"></span>
      <label for="propertyType">Tipo de propiedad</label>
      <select id="propertyType" name="propertyType" required>
        <option value="Apartment" <%= accommodation.propertyType === 'Apartment' ? 'selected' : '' %>>Apartamento</option>
        <option value="House" <%= accommodation.propertyType === 'House' ? 'selected' : '' %>>Casa</option>
        <option value="Studio" <%= accommodation.propertyType === 'Studio' ? 'selected' : '' %>>Estudio</option>
        <option value="Loft" <%= accommodation.propertyType === 'Loft' ? 'selected' : '' %>>Loft</option>
        <option value="Other" <%= accommodation.propertyType === 'Other' ? 'selected' : '' %>>Otro</option>
      </select>
      <span class="field-error" id="propertyTypeError"></span>
      <label for="petsAllowed">¿Se permiten mascotas?</label>
      <select id="petsAllowed" name="petsAllowed" required>
        <option value="true" <%= accommodation.petsAllowed ? 'selected' : '' %>>Sí</option>
        <option value="false" <%= !accommodation.petsAllowed ? 'selected' : '' %>>No</option>
      </select>
      <span class="field-error" id="petsAllowedError"></span>
      <label for="address">Dirección</label>
      <input type="text" id="address" name="address" value="<%= accommodation.location.address %>" required>
      <span class="field-error" id="addressError"></span>
      <label for="city">Ciudad</label>
      <input type="text" id="city" name="city" value="<%= accommodation.location.city %>" required>
      <span class="field-error" id="cityError"></span>
      <label for="country">País</label>
      <input type="text" id="country" name="country" value="<%= accommodation.location.country %>" required>
      <span class="field-error" id="countryError"></span>
      <label for="postalCode">Código Postal</label>
      <input type="text" id="postalCode" name="postalCode" value="<%= accommodation.location.postalCode %>" required>
      <span class="field-error" id="postalCodeError"></span>
      <label for="checkIn">Check-in</label>
      <input type="time" id="checkIn" name="checkIn" value="<%= accommodation.checkIn %>" required>
      <span class="field-error" id="checkInError"></span>
      <label for="checkOut">Check-out</label>
      <input type="time" id="checkOut" name="checkOut" value="<%= accommodation.checkOut %>" required>
      <span class="field-error" id="checkOutError"></span>
      <label for="houseRules">Reglas de la casa</label>
      <textarea id="houseRules" name="houseRules" maxlength="1000"><%= accommodation.houseRules %></textarea>
      <span class="field-error" id="houseRulesError"></span>
      <label for="cancellationPolicy">Política de cancelación</label>
      <select id="cancellationPolicy" name="cancellationPolicy" required>
        <option value="Flexible" <%= accommodation.cancellationPolicy === 'Flexible' ? 'selected' : '' %>>Flexible</option>
        <option value="Moderate" <%= accommodation.cancellationPolicy === 'Moderate' ? 'selected' : '' %>>Moderada</option>
        <option value="Strict" <%= accommodation.cancellationPolicy === 'Strict' ? 'selected' : '' %>>Estrica</option>
        <option value="Super Strict" <%= accommodation.cancellationPolicy === 'Super Strict' ? 'selected' : '' %>>Super estricta</option>
        <option value="No Refund" <%= accommodation.cancellationPolicy === 'No Refund' ? 'selected' : '' %>>Sin reembolso</option>
        <option value="Other" <%= accommodation.cancellationPolicy === 'Other' ? 'selected' : '' %>>Otra</option>
      </select>
      <span class="field-error" id="cancellationPolicyError"></span>
      <label for="amenities">Comodidades (amenities)</label>
      <input type="text" id="amenities" name="amenities" value="<%= (accommodation.amenities || []).join(', ') %>" placeholder="Ej: Wifi, Piscina, TV" />
      <span class="field-error" id="amenitiesError"></span>
      <input type="hidden" name="hostId" value="<%= accommodation.hostId %>">
      <button type="submit">Guardar Cambios</button>
    </form>
    <style>
      .input-error { border-color: #c00 !important; }
      .field-error { color: #c00; font-size: 0.9em; min-height: 1.2em; display: block; }
    </style>
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const form = document.querySelector('form');
        const errorBox = document.createElement('div');
        errorBox.id = 'formErrorBox';
        errorBox.style.color = '#c00';
        errorBox.style.marginBottom = '1em';
        form.prepend(errorBox);
        // Field references
        const fields = {
          title: form.title,
          description: form.description,
          pricePerNight: form.pricePerNight,
          squareMeters: form.squareMeters,
          mainPhoto: form.mainPhoto,
          rooms: form.rooms,
          beds: form.beds,
          bathrooms: form.bathrooms,
          propertyType: form.propertyType,
          petsAllowed: form.petsAllowed,
          address: form.address,
          city: form.city,
          country: form.country,
          postalCode: form.postalCode,
          checkIn: form.checkIn,
          checkOut: form.checkOut,
          houseRules: form.houseRules,
          cancellationPolicy: form.cancellationPolicy,
          amenities: form.amenities
        };
        const errors = {
          title: document.getElementById('titleError'),
          description: document.getElementById('descriptionError'),
          pricePerNight: document.getElementById('priceError'),
          squareMeters: document.getElementById('squareMetersError'),
          mainPhoto: document.getElementById('mainPhotoError'),
          rooms: document.getElementById('roomsError'),
          beds: document.getElementById('bedsError'),
          bathrooms: document.getElementById('bathroomsError'),
          propertyType: document.getElementById('propertyTypeError'),
          petsAllowed: document.getElementById('petsAllowedError'),
          address: document.getElementById('addressError'),
          city: document.getElementById('cityError'),
          country: document.getElementById('countryError'),
          postalCode: document.getElementById('postalCodeError'),
          checkIn: document.getElementById('checkInError'),
          checkOut: document.getElementById('checkOutError'),
          houseRules: document.getElementById('houseRulesError'),
          cancellationPolicy: document.getElementById('cancellationPolicyError'),
          amenities: document.getElementById('amenitiesError')
        };
        function setFieldError(input, errorSpan, msg) {
          errorSpan.textContent = msg;
          if (msg) input.classList.add('input-error');
          else input.classList.remove('input-error');
        }
        function clearError() { errorBox.textContent = ''; }
        // Real-time validation for required fields
        fields.title.addEventListener('input', function() {
          if (fields.title.value.length < 5 || fields.title.value.length > 100) setFieldError(fields.title, errors.title, 'Título 5-100 caracteres.');
          else setFieldError(fields.title, errors.title, '');
        });
        fields.description.addEventListener('input', function() {
          if (fields.description.value.length < 30 || fields.description.value.length > 2000) setFieldError(fields.description, errors.description, 'Descripción 30-2000 caracteres.');
          else setFieldError(fields.description, errors.description, '');
        });
        fields.pricePerNight.addEventListener('input', function() {
          if (fields.pricePerNight.value < 10 || fields.pricePerNight.value > 100000) setFieldError(fields.pricePerNight, errors.pricePerNight, 'Precio 10-100000.');
          else setFieldError(fields.pricePerNight, errors.pricePerNight, '');
        });
        fields.squareMeters.addEventListener('input', function() {
          if (fields.squareMeters.value < 10 || fields.squareMeters.value > 1000) setFieldError(fields.squareMeters, errors.squareMeters, '10-1000 m2.');
          else setFieldError(fields.squareMeters, errors.squareMeters, '');
        });
        fields.rooms.addEventListener('input', function() {
          if (fields.rooms.value < 1 || fields.rooms.value > 20) setFieldError(fields.rooms, errors.rooms, 'Habitaciones 1-20.');
          else setFieldError(fields.rooms, errors.rooms, '');
        });
        fields.beds.addEventListener('input', function() {
          if (fields.beds.value < 1 || fields.beds.value > 40) setFieldError(fields.beds, errors.beds, 'Camas 1-40.');
          else setFieldError(fields.beds, errors.beds, '');
        });
        fields.bathrooms.addEventListener('input', function() {
          if (fields.bathrooms.value < 1 || fields.bathrooms.value > 20) setFieldError(fields.bathrooms, errors.bathrooms, 'Baños 1-20.');
          else setFieldError(fields.bathrooms, errors.bathrooms, '');
        });
        fields.address.addEventListener('input', function() {
          if (fields.address.value.length < 5) setFieldError(fields.address, errors.address, 'Dirección requerida.');
          else setFieldError(fields.address, errors.address, '');
        });
        fields.city.addEventListener('input', function() {
          if (fields.city.value.length < 2) setFieldError(fields.city, errors.city, 'Ciudad requerida.');
          else setFieldError(fields.city, errors.city, '');
        });
        fields.country.addEventListener('input', function() {
          if (fields.country.value.length < 2) setFieldError(fields.country, errors.country, 'País requerido.');
          else setFieldError(fields.country, errors.country, '');
        });
        fields.postalCode.addEventListener('input', function() {
          if (fields.postalCode.value.length < 3) setFieldError(fields.postalCode, errors.postalCode, 'Código postal requerido.');
          else setFieldError(fields.postalCode, errors.postalCode, '');
        });
        fields.propertyType.addEventListener('change', function() {
          if (!fields.propertyType.value) setFieldError(fields.propertyType, errors.propertyType, 'Selecciona tipo de propiedad.');
          else setFieldError(fields.propertyType, errors.propertyType, '');
        });
        fields.petsAllowed.addEventListener('change', function() {
          if (!fields.petsAllowed.value) setFieldError(fields.petsAllowed, errors.petsAllowed, 'Selecciona si se permiten mascotas.');
          else setFieldError(fields.petsAllowed, errors.petsAllowed, '');
        });
        // On submit, check all fields
        form.addEventListener('submit', function(e) {
          clearError();
          let hasError = false;
          if (fields.title.value.length < 5 || fields.title.value.length > 100) { setFieldError(fields.title, errors.title, 'Título 5-100 caracteres.'); hasError = true; }
          if (fields.description.value.length < 30 || fields.description.value.length > 2000) { setFieldError(fields.description, errors.description, 'Descripción 30-2000 caracteres.'); hasError = true; }
          if (fields.pricePerNight.value < 10 || fields.pricePerNight.value > 100000) { setFieldError(fields.pricePerNight, errors.pricePerNight, 'Precio 10-100000.'); hasError = true; }
          if (fields.squareMeters.value < 10 || fields.squareMeters.value > 1000) { setFieldError(fields.squareMeters, errors.squareMeters, '10-1000 m2.'); hasError = true; }
          if (fields.rooms.value < 1 || fields.rooms.value > 20) { setFieldError(fields.rooms, errors.rooms, 'Habitaciones 1-20.'); hasError = true; }
          if (fields.beds.value < 1 || fields.beds.value > 40) { setFieldError(fields.beds, errors.beds, 'Camas 1-40.'); hasError = true; }
          if (fields.bathrooms.value < 1 || fields.bathrooms.value > 20) { setFieldError(fields.bathrooms, errors.bathrooms, 'Baños 1-20.'); hasError = true; }
          if (fields.address.value.length < 5) { setFieldError(fields.address, errors.address, 'Dirección requerida.'); hasError = true; }
          if (fields.city.value.length < 2) { setFieldError(fields.city, errors.city, 'Ciudad requerida.'); hasError = true; }
          if (fields.country.value.length < 2) { setFieldError(fields.country, errors.country, 'País requerido.'); hasError = true; }
          if (fields.postalCode.value.length < 3) { setFieldError(fields.postalCode, errors.postalCode, 'Código postal requerido.'); hasError = true; }
          if (!fields.propertyType.value) { setFieldError(fields.propertyType, errors.propertyType, 'Selecciona tipo de propiedad.'); hasError = true; }
          if (!fields.petsAllowed.value) { setFieldError(fields.petsAllowed, errors.petsAllowed, 'Selecciona si se permiten mascotas.'); hasError = true; }
          if (hasError) { errorBox.textContent = 'Corrige los errores antes de enviar.'; e.preventDefault(); }
        });
      });
    </script>
  </main>
</body>
</html>
